{% extends "base.html" %}
{% block title %}Inventario{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
  .grid{display:grid;gap:1rem;}
  @media (min-width:576px){.grid{grid-template-columns:repeat(2,1fr);} }
  @media (min-width:768px){.grid{grid-template-columns:repeat(3,1fr);} }

  .inv-card{cursor:pointer;transition:.25s;}
  .inv-card:hover{transform:translateY(-2px);box-shadow:0 .5rem 1rem rgba(0,0,0,.1);}

  .fade-page{animation:fade .25s both;}
  @keyframes fade{from{opacity:0;transform:translateY(8px);} to{opacity:1;}}

  /* nav & back buttons */
  #crumb{position:sticky;top:0;z-index:100;background:#fff;padding:.5rem 0;}
  #backBtn{padding:.5rem .75rem!important;line-height:1;}
  #backBtn i{font-size:2rem;}          /* bigger icon */
  #backFab{width:4rem;height:4rem;border-radius:50%;display:none;place-items:center;}

  .form-switch .form-check-input{width:3.1rem;height:1.55rem;cursor:pointer;transition:.25s;}
  .form-switch .form-check-input:focus{box-shadow:none;}

  /* breadcrumb links */
  .crumb-link{cursor:pointer;text-decoration:none;color:inherit;}
  .crumb-link:hover{text-decoration:underline;}
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
  <!-- breadcrumb -->
  <nav id="crumb" class="d-flex align-items-center mb-3">
    <button id="backBtn" class="btn btn-link p-0 me-2 d-none">
      <i class="bi bi-arrow-left"></i>
    </button>
    <span id="crumbText" class="fw-semibold"></span>
  </nav>

  <!-- viewport -->
  <div id="view" class="fade-page"></div>
</div>

<!-- floating back FAB -->
<button id="backFab"
        class="btn btn-primary position-fixed shadow"
        style="bottom:1rem;left:1rem;z-index:1050;">
  <i class="bi bi-arrow-left fs-4 text-white"></i>
</button>

<!-- toast for long details -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toast" class="toast align-items-center text-bg-secondary border-0" role="alert">
    <div class="d-flex">
      <div id="toastBody" class="toast-body"></div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- value-entry modal -->
<div class="modal fade" id="valueModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle" class="modal-title"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <span id="modalMeasure" class="badge bg-secondary"></span>
          <p id="modalDetails" class="small text-muted mb-0"></p>
        </div>
        <div class="form-floating mb-4">
          <input id="valueInput" type="number" min="0" step="any"
                 class="form-control" placeholder="Valor">
          <label for="valueInput">Valor</label>
        </div>
        <div class="d-flex justify-content-center mb-4">
          <div class="form-switch">
            <input id="locSwitch" class="form-check-input" type="checkbox">
          </div>
          <span id="locLabel" class="ms-3 fw-semibold align-self-center">Tienda</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="saveBtn" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  /* ---------- data ---------- */
  const raw={{ inventory | tojson }};
  const byArea={};
  raw.forEach(r=>{
    (byArea[r.area] ??= {})[r.category] ??= [];
    byArea[r.area][r.category].push(r);
  });

  /* ---------- refs ---------- */
  const view=document.getElementById('view');
  const crumb=document.getElementById('crumbText');
  const backBtn=document.getElementById('backBtn');
  const fab=document.getElementById('backFab');

  const modal=new bootstrap.Modal('#valueModal');
  const mTitle=document.getElementById('modalTitle');
  const mMeasure=document.getElementById('modalMeasure');
  const mDetails=document.getElementById('modalDetails');
  const valInput=document.getElementById('valueInput');
  const locSwitch=document.getElementById('locSwitch');
  const locLabel=document.getElementById('locLabel');
  const saveBtn=document.getElementById('saveBtn');

  const toast=new bootstrap.Toast(document.getElementById('toast'));
  const toastBody=document.getElementById('toastBody');

  /* ---------- state ---------- */
  let nav=[];      // [], [area], [area,cat]
  let currentId=null;
  const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);
  const warn=v=>(v==null||v===0)?'text-danger fw-semibold':'text-success';

  /* ---------- breadcrumb ---------- */
  function drawBreadcrumb(){
    if(nav.length===0){ crumb.textContent='Áreas'; return; }
    let html=`<a class="crumb-link" data-level="root">Áreas</a> / `;
    if(nav.length>=1){
      html+=nav.length===1
        ? `<span class="fw-semibold text-decoration-underline">${cap(nav[0])}</span>`
        : `<a class="crumb-link" data-level="area">${cap(nav[0])}</a> / `;
    }
    if(nav.length===2){
      html+=`<span class="fw-semibold text-decoration-underline">${cap(nav[1])}</span>`;
    }
    crumb.innerHTML=html;
    crumb.querySelectorAll('.crumb-link').forEach(a=>{
      a.onclick=e=>{
        const lvl=e.target.dataset.level;
        nav = lvl==='root' ? [] : [nav[0]];
        render();
      };
    });
  }

  /* ---------- render ---------- */
  function render(){
    view.innerHTML='';
    drawBreadcrumb();
    const showBack=nav.length>0;
    backBtn.classList.toggle('d-none',!showBack);
    fab.style.display=showBack?'grid':'none';

    if(nav.length===0){
      makeGrid(Object.keys(byArea),a=>{nav=[a];render();});
    }else if(nav.length===1){
      makeGrid(Object.keys(byArea[nav[0]]),c=>{nav=[nav[0],c];render();});
    }else{
      productGrid(byArea[nav[0]][nav[1]]);
    }
  }
  const makeGrid=(list,cb)=>{
    const g=document.createElement('div');g.className='grid';
    list.forEach(t=>{
      const card=document.createElement('div');
      card.className='card inv-card shadow-sm rounded-3';
      card.innerHTML=`<div class="card-body text-center py-4 fw-semibold text-capitalize">${t.replace('_',' ')}</div>`;
      card.onclick=()=>cb(t);
      g.appendChild(card);
    });
    view.appendChild(g);
  };
  const productGrid=list=>{
    const g=document.createElement('div');g.className='grid';
    list.forEach(p=>{
      const needs=p.tienda==null&&p.bodega==null;
      const card=document.createElement('div');
      card.className='card inv-card shadow-sm rounded-3';
      card.dataset.pid=p.id;

      card.innerHTML=`
        <div class="card-body d-flex flex-column align-items-center py-3">
          <div class="fw-semibold text-center text-dark">${p.name}</div>
          <small class="text-muted">${p.measure}</small>
          ${needs?`<div class="mt-2 small text-danger fw-semibold">Hace&nbsp;falta&nbsp;conteo</div>`
                 :`<div class="mt-3 small d-flex flex-column align-items-center counts">
                      <span class="${warn(p.tienda)}">En&nbsp;tienda:&nbsp;${p.tienda??'-'}</span>
                      <span class="${warn(p.bodega)}">En&nbsp;bodega:&nbsp;${p.bodega??'-'}</span>
                    </div>`}
          ${p.details?`<button type="button" class="btn btn-link p-0 mt-2 text-info info-btn">
                         <i class="bi bi-info-circle"></i></button>`:''}
        </div>`;
      card.onclick=()=>openModal(p);
      card.querySelector('.info-btn')?.addEventListener('click',e=>{
        e.preventDefault();e.stopPropagation();
        toastBody.textContent=p.details;toast.show();
      });
      g.appendChild(card);
    });
    view.appendChild(g);
  };

  /* ---------- modal ---------- */
  function openModal(p){
    currentId=p.id;
    mTitle.textContent=p.name;
    mMeasure.textContent=p.measure;
    mDetails.textContent=p.details||'';
    mDetails.style.display=p.details?'block':'none';
    valInput.value='';valInput.classList.remove('is-invalid');
    locSwitch.checked=false;locLabel.textContent='Tienda';
    modal.show();
  }
  locSwitch.onchange=()=>locLabel.textContent=locSwitch.checked?'Bodega':'Tienda';

  const updateCounts=id=>{
    const prod=raw.find(x=>x.id===id);
    const c=document.querySelector(`[data-pid="${id}"] .counts`);
    if(c){
      c.innerHTML=
        `<span class="${warn(prod.tienda)}">En&nbsp;tienda:&nbsp;${prod.tienda??'-'}</span>
         <span class="${warn(prod.bodega)}">En&nbsp;bodega:&nbsp;${prod.bodega??'-'}</span>`;
    }
  };
  saveBtn.onclick=async()=>{
    const val=parseFloat(valInput.value);
    if(isNaN(val)||val<0){valInput.classList.add('is-invalid');return;}
    valInput.classList.remove('is-invalid');saveBtn.disabled=true;
    const loc=locSwitch.checked?'bodega':'tienda';
    try{
      const res=await fetch(`/inventory/${currentId}/value`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({value:val,location:loc})
      });
      if(!res.ok) throw new Error('Error al guardar');
      raw.find(x=>x.id===currentId)[loc]=val;   // local update
      modal.hide(); updateCounts(currentId);
    }catch(e){alert(e.message);}
    finally{saveBtn.disabled=false;}
  };

  /* ---------- back & swipe ---------- */
  const goBack=()=>{if(nav.length){nav.pop();render();}};
  backBtn.onclick=goBack; fab.onclick=goBack;
  (()=>{let sx=0,sy=0;
    window.addEventListener('touchstart',e=>{
      if(e.touches.length===1){sx=e.touches[0].clientX;sy=e.touches[0].clientY;}
    },{passive:true});
    window.addEventListener('touchend',e=>{
      if(!sx)return;
      const dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;
      if(dx<-60&&Math.abs(dx)>Math.abs(dy))goBack();
      sx=sy=0;
    },{passive:true});
  })();

  /* ---------- boot ---------- */
  render();
})();
</script>
{% endblock %}
