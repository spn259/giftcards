{# templates/insumo_request.html #}
{% extends "base.html" %}
{% block title %}Solicitud de Insumos{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
  .fade-page{animation:fade .25s both}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1}}

  .btn-group{flex-wrap:wrap}
  .btn-group .btn{flex:1 1 0;text-transform:uppercase;margin:2px 0}
  @media(min-width:576px){.btn-group .btn{margin:0}}

  textarea{resize:vertical;min-height:72px}

  @media(max-width:575.98px){
    .sticky-submit{position:sticky;bottom:0;left:0;right:0;z-index:10;border-radius:0}
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 fade-page">
  <h2 class="fs-5 text-center mb-4">Solicitud de insumos</h2>

  <form id="insumoForm" class="needs-validation" novalidate>
    <input type="hidden" name="employee" value="{{ employee_name }}">

    <!-- Empleado -->
    <div class="mb-3">
      <label class="form-label fw-semibold mb-1">Empleado</label>
      <input type="text" class="form-control-plaintext" value="{{ employee_name }}" readonly>
    </div>

    <!-- Insumo -->
    <div class="mb-3">
      <label class="form-label fw-semibold mb-1" for="insumo">
        Insumo <span class="text-danger">*</span>
      </label>
      <input type="text" class="form-control" id="insumo" name="insumo"
             list="insumoList" placeholder="Ej. Harina, AzÃºcarâ€¦" required autocomplete="off">
      <datalist id="insumoList">
        {% for nombre in insumo_names %}<option value="{{ nombre }}">{% endfor %}
      </datalist>
      <div class="invalid-feedback">El nombre del insumo es obligatorio.</div>
    </div>

    <!-- Medida -->
    <div class="mb-3">
      <label class="form-label fw-semibold mb-1 d-block">
        Unidad <span class="text-danger">*</span>
      </label>
      <div class="btn-group w-100" role="group">
        {% for u,lbl in [('pz','PZ'),('kg','KG'),('g','G'),('l','L'),('ml','ML')] %}
          <input type="radio" class="btn-check" name="measure" id="measure_{{u}}"
                 value="{{u}}" autocomplete="off" {% if loop.first %}required{% endif %}>
          <label class="btn btn-outline-secondary btn-sm" for="measure_{{u}}">{{lbl}}</label>
        {% endfor %}
      </div>
      <div class="invalid-feedback d-block">Â¿CÃ³mo se mide este insumo?</div>
    </div>

    <!-- Cantidad -->
    <div class="mb-3">
      <label class="form-label fw-semibold mb-1" for="quantity">
        Cantidad <span class="text-danger">*</span>
      </label>
      <input type="number" step="any" min="0" class="form-control"
             id="quantity" name="quantity" placeholder="0" inputmode="decimal" required>
      <div class="invalid-feedback">Ingresa la cantidad.</div>
    </div>

    <!-- Urgencia -->
    <div class="mb-3">
      <label class="form-label fw-semibold mb-1 d-block">
        Urgencia <span class="text-danger">*</span>
      </label>
      <div class="btn-group w-100" role="group">
        {% for v,lbl in [('ahora','Ahora'),('hoy','Hoy p/ maÃ±ana'),
                         ('manana','MaÃ±ana'),('proximos_dias','PrÃ³x. dÃ­as')] %}
          <input type="radio" class="btn-check" name="urgency" id="urg_{{v}}"
                 value="{{v}}" autocomplete="off" {% if loop.first %}required{% endif %}>
          <label class="btn btn-outline-primary btn-sm" for="urg_{{v}}">{{lbl}}</label>
        {% endfor %}
      </div>
      <div class="invalid-feedback d-block">Selecciona la urgencia.</div>
    </div>

    <!-- Notas -->
    <div class="mb-4">
      <label class="form-label fw-semibold mb-1" for="notes">Notas (opcional)</label>
      <textarea class="form-control" id="notes" name="notes"
                rows="2" placeholder="Detalles adicionalesâ€¦"></textarea>
    </div>

    <button class="btn btn-primary w-100 sticky-submit" type="submit">
      <i class="bi bi-send me-1"></i>Enviar solicitud
    </button>
  </form>

  <div id="alertSuccess" class="alert alert-success mt-3 d-none" role="alert">
    Â¡Solicitud enviada! ðŸŽ‰
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  const form       = document.getElementById('insumoForm');
  const alertBox   = document.getElementById('alertSuccess');
  const insumo     = document.getElementById('insumo');
  const measureRad = () => document.querySelectorAll('input[name="measure"]');

  /* mapa insumo â†’ medida (case-insensitive) */
  const map = {};
  Object.entries({{ insumos | tojson }}).forEach(([k,v])=>{
    map[k.trim().toLowerCase()] = v;
  });

  const normalize = u=>{
    if(!u) return '';
    const m={PZ:'pz',KG:'kg',L:'l',GR:'g',G:'g'};
    return m[u.toUpperCase()]||u.toLowerCase();
  };

  const autofill = ()=>{
    const val = normalize(map[insumo.value.trim().toLowerCase()]);
    if(val){
      measureRad().forEach(r=>r.checked = (r.value === val));
    }
  };

  /* Firefox Mobile: el evento relevante es 'keyup' (se dispara al tocar sugerencia);
     mantenemos 'input' y 'change' para otros navegadores */
  ['input','change','keyup','blur'].forEach(ev=>insumo.addEventListener(ev,autofill));

  form.addEventListener('submit', async e => {
    e.preventDefault(); e.stopPropagation();
    form.classList.add('was-validated');
    if(!form.checkValidity()) return;

    const data = Object.fromEntries(new FormData(form).entries());
    try{
      const res = await fetch('{{ url_for("create_insumo_request") }}',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      });
      if(!res.ok) throw new Error('Error al guardar');
      form.reset(); form.classList.remove('was-validated');
      alertBox.classList.remove('d-none');
      setTimeout(()=>alertBox.classList.add('d-none'),4000);
    }catch(err){ alert(err.message); }
  });
})();
</script>
{% endblock %}
