{% extends "base.html" %}
{% block title %}Solicitud de Insumos{% endblock %}

{% block head %}
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
  .fade-page{animation:fade .25s both}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1}}

  /* espaciar botones radios en mobile */
  .btn-group .btn{flex:1 1 0;text-transform:uppercase}
</style>
{% endblock %}

{% block content %}
<div class="container py-4 fade-page">
  <h2 class="fs-5 text-center mb-4">Solicitud de insumos</h2>

  <!-- â”€â”€ formulario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <form id="insumoForm" class="needs-validation" novalidate>
    <!-- Hidden employee -->
    <input type="hidden" name="employee" value="{{ employee_name }}">

    <!-- Empleado (solo lectura) -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Empleado</label>
      <input type="text" class="form-control-plaintext"
             value="{{ employee_name }}" readonly>
    </div>

    <!-- Insumo con datalist -->
    <div class="mb-3">
      <label class="form-label fw-semibold" for="insumo">
        Insumo <span class="text-danger">*</span>
      </label>
      <input type="text" class="form-control" id="insumo" name="insumo"
             list="insumoList" placeholder="Ej. Harina, AzÃºcarâ€¦" required>
      <datalist id="insumoList">
        {% for nombre in insumo_names %}
          <option value="{{ nombre }}">
        {% endfor %}
      </datalist>
      <div class="invalid-feedback">El nombre del insumo es obligatorio.</div>
    </div>

    <!-- Medida + Cantidad -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <label class="form-label fw-semibold d-block mb-1">
          Unidad <span class="text-danger">*</span>
        </label>

        <!-- Botones de medida -->
        <div class="btn-group w-100" role="group" aria-label="Unidad">
          {% for u, lbl in [('pz','PZ'), ('kg','KG'), ('g','G'), ('l','L'), ('ml','ML')] %}
            <input type="radio" class="btn-check" name="measure" id="measure_{{ u }}"
                   value="{{ u }}" autocomplete="off" {% if loop.first %}required{% endif %}>
            <label class="btn btn-outline-secondary btn-sm" for="measure_{{ u }}">{{ lbl }}</label>
          {% endfor %}
        </div>
        <div class="invalid-feedback d-block">Â¿CÃ³mo se mide este insumo?</div>
      </div>

      <div class="col-12">
        <label class="form-label fw-semibold" for="quantity">
          Cantidad <span class="text-danger">*</span>
        </label>
        <input type="number" step="any" min="0"
               class="form-control" id="quantity" name="quantity"
               placeholder="0" required>
        <div class="invalid-feedback">Ingresa la cantidad.</div>
      </div>
    </div>

    <!-- Urgencia -->
    <div class="mb-3">
      <label class="form-label fw-semibold d-block mb-1">
        Urgencia <span class="text-danger">*</span>
      </label>

      <!-- Botones de urgencia -->
      <div class="btn-group w-100" role="group" aria-label="Urgencia">
        {% for v, lbl in [('ahora mismo','Ahora Mismo'), ('hoy para maÃ±ana','Hoy para maÃ±ana'), ('manana','MaÃ±ana'), ('proximos_dias','PrÃ³x. dÃ­as')] %}
          <input type="radio" class="btn-check" name="urgency" id="urg_{{ v }}"
                 value="{{ v }}" autocomplete="off" {% if loop.first %}required{% endif %}>
          <label class="btn btn-outline-primary btn-sm" for="urg_{{ v }}">{{ lbl }}</label>
        {% endfor %}
      </div>
      <div class="invalid-feedback d-block">Selecciona el nivel de urgencia.</div>
    </div>

    <!-- Notas -->
    <div class="mb-4">
      <label class="form-label fw-semibold" for="notes">Notas (opcional)</label>
      <textarea class="form-control" id="notes" name="notes"
                rows="2" placeholder="Detalles adicionalesâ€¦"></textarea>
    </div>

    <button class="btn btn-primary w-100" type="submit">
      <i class="bi bi-send me-1"></i>Enviar solicitud
    </button>
  </form>

  <!-- Ã©xito -->
  <div id="alertSuccess"
       class="alert alert-success mt-3 d-none" role="alert">
    Â¡Solicitud enviada! ðŸŽ‰
  </div>
</div>

<!-- â”€â”€ scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  const form       = document.getElementById('insumoForm');
  const alertBox   = document.getElementById('alertSuccess');
  const insumo     = document.getElementById('insumo');
  const measureRad = () => document.querySelectorAll('input[name="measure"]');

  /* Mapa insumo â†’ medida */
  const insumosMap = {{ insumos | tojson }};

  /* Normaliza unidades BD â†’ radios */
  const normalize = (u) => {
    if(!u) return '';
    const map={PZ:'pz',KG:'kg',L:'l',GR:'g',G:'g'};
    return map[u.toUpperCase()]||u.toLowerCase();
  };

  /* Autocompleta medida */
  insumo.addEventListener('change', () => {
    const val = normalize(insumosMap[insumo.value.trim()]);
    measureRad().forEach(r => r.checked = r.value === val);
  });

  /* envÃ­o AJAX */
  form.addEventListener('submit', async (e) => {
    e.preventDefault(); e.stopPropagation();
    form.classList.add('was-validated');
    if(!form.checkValidity()) return;

    const data = Object.fromEntries(new FormData(form).entries());
    try{
      const res = await fetch('{{ url_for("create_insumo_request") }}',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      });
      if(!res.ok) throw new Error('Error al guardar');
      form.reset(); form.classList.remove('was-validated');
      alertBox.classList.remove('d-none');
      setTimeout(()=>alertBox.classList.add('d-none'),4000);
    }catch(err){ alert(err.message);}
  });
})();
</script>
{% endblock %}
