<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Encuesta · Experiencia</title>

  <!-- Bootstrap & Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <style>
    /* ---------- Layout ---------- */
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
    }
    .survey-wrapper { width: 90vw; max-width: 1200px; }

    /* ---------- Rows ---------- */
    .survey-row {
      padding: 1.75rem 2rem;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-radius: 1.25rem;
      box-shadow: 0 0.5rem 1.2rem -0.3rem rgb(0 0 0 / 0.15);
      margin-bottom: 1.75rem;
    }

    /* ---------- Category icons ---------- */
    .category-icon { font-size: 2rem; opacity: 0.85; }

    /* ---------- Rating buttons ---------- */
    .emoji-btn {
      font-size: clamp(3.5rem, 6vw, 5rem);
      cursor: pointer;
      transition: transform 0.15s, filter 0.15s;
    }
    .emoji-btn[data-val="1"] { color:#dc3545; }  /* rojo   */
    .emoji-btn[data-val="2"] { color:#ffc107; }  /* amarillo */
    .emoji-btn[data-val="3"] { color:#198754; }  /* verde  */
    .emoji-btn:hover {
      transform: translateY(-5px) scale(1.08);
      filter: brightness(1.2);
    }
    .emoji-btn.active {
      transform: scale(1.12);
      filter: brightness(1.3) drop-shadow(0 0 6px rgba(0,0,0,0.15));
    }

    /* ---------- Toast ---------- */
    .toast { font-size: 1.1rem; }

    @media (min-width: 768px) {
      .survey-row { padding: 2rem 3rem; font-size: 1.5rem; }
      .category-icon { font-size: 2.25rem; }
    }
  </style>
</head>

<body>
  <div class="survey-wrapper fade-page">
    <h1 class="text-center mb-5 fw-bold display-5">Valora tu experiencia</h1>

    <!-- Survey grid -->
    <form id="survey" class="w-100">
      <!-- Row template -->
      <template id="rowTpl">
        <div class="survey-row">
          <span class="d-flex align-items-center flex-grow-1 fw-semibold text-capitalize">
            <i class="bi category-icon me-2"></i>
            <span class="label-text"></span>
          </span>

          <div class="d-flex gap-4">
            <i class="bi bi-emoji-frown   emoji-btn" data-val="1"></i>
            <i class="bi bi-emoji-neutral emoji-btn" data-val="2"></i>
            <i class="bi bi-emoji-smile   emoji-btn" data-val="3"></i>
          </div>
          <input type="hidden" name="" />
        </div>
      </template>
    </form>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1100">
    <div id="toastFeed" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body fw-semibold">Gracias por tu feedback 🎉</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (() => {
      /* ---------- 1. Build rows ---------- */
      const areas = ["comida", "servicio", "limpieza"];
      const iconClasses = { servicio: "bi-bell", limpieza: "bi-bucket" };
      const survey = document.getElementById("survey");
      const tpl = document.getElementById("rowTpl").content;

      areas.forEach(area => {
        const row = tpl.cloneNode(true);

        // label & icon
        row.querySelector(".label-text").textContent = area;
        const iconEl = row.querySelector(".category-icon");
        if (area === "comida") {
          iconEl.classList.remove("bi");
          iconEl.textContent = "🍩";            // donut emoji
        } else {
          iconEl.classList.add(iconClasses[area]);
        }

        row.querySelector("input").name = area;

        row.querySelectorAll(".emoji-btn").forEach(btn =>
          btn.addEventListener("click", () => handleSelect(btn))
        );

        survey.appendChild(row);
      });

      /* ---------- 2. Helpers ---------- */
      const valueOf   = a => survey.elements[a].value;
      const isComplete = () => areas.every(a => valueOf(a));

      function handleSelect(btn) {
        const wasComplete = isComplete();        // status before click

        // mark choice as active
        const row = btn.closest(".survey-row");
        row.querySelectorAll(".emoji-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        row.querySelector("input").value = btn.dataset.val;

        if (!wasComplete && isComplete()) submitSurvey();  // First time full
      }

      /* ---------- 3. Submit ---------- */
      const toast = new bootstrap.Toast(document.getElementById("toastFeed"));

      async function submitSurvey() {
        const payload = Object.fromEntries(areas.map(a => [a, valueOf(a)]));

        try {
          await fetch("/survey/submit", {
            method : "POST",
            headers: { "Content-Type": "application/json" },
            body   : JSON.stringify(payload),
          });
          toast.show();
        } catch (err) {
          alert("Hubo un problema al enviar tu respuesta.");
        } finally {
          resetSurvey();
        }
      }

      function resetSurvey() {
        survey.querySelectorAll(".emoji-btn").forEach(b => b.classList.remove("active"));
        survey.reset();
      }
    })();
  </script>
</body>
</html>
